<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Flagon WASM Demo</title>
</head>
<body>
    <h1>Flagon CLI WASM Demo</h1>
    <div id="status">Loading WASM...</div>
    <div>
        <label for="command">Command:</label>
        <input type="text" id="command" value="help" />
        <button id="runBtn" onclick="executeCommand()" disabled>Run</button>
    </div>
    <div>
        <label for="lua">Lua Script:</label>
        <textarea id="lua" rows="5" cols="50">command {
  name = "hello",
  description = "Say hello",
  handler = function(ctx)
    print("Hello from Lua!")
  end
}</textarea>
        <button id="loadBtn" onclick="executeLua()" disabled>Load Lua</button>
    </div>
    <div>
        <label for="output">Output:</label>
        <pre id="output"></pre>
    </div>

    <script src="wasm_exec.js"></script>
    <script>
        let wasmLoaded = false;

        const go = new Go();
        WebAssembly.instantiateStreaming(fetch("flagon.wasm"), go.importObject).then((result) => {
            go.run(result.instance);
            wasmLoaded = true;
            document.getElementById('status').textContent = 'WASM loaded successfully!';
            document.getElementById('runBtn').disabled = false;
            document.getElementById('loadBtn').disabled = false;
            
            // Debug: Check if functions are available
            console.log('Available global functions:', Object.keys(globalThis).filter(key => typeof globalThis[key] === 'function'));
            console.log('runCommand available:', typeof globalThis.runCommand);
            console.log('loadLuaPlugin available:', typeof globalThis.loadLuaPlugin);
        }).catch((err) => {
            document.getElementById('status').textContent = 'Failed to load WASM: ' + err;
            console.error(err);
        });

        function executeCommand() {
            if (!wasmLoaded) {
                document.getElementById('output').textContent = 'WASM not loaded yet';
                return;
            }
            try {
                const cmd = document.getElementById('command').value;
                const result = globalThis.runCommand(cmd);
                document.getElementById('output').textContent = result;
            } catch (err) {
                document.getElementById('output').textContent = 'Error: ' + err;
                console.error(err);
            }
        }

        function executeLua() {
            if (!wasmLoaded) {
                document.getElementById('output').textContent = 'WASM not loaded yet';
                return;
            }
            try {
                const script = document.getElementById('lua').value;
                const result = globalThis.loadLuaPlugin(script);
                document.getElementById('output').textContent = result;
            } catch (err) {
                document.getElementById('output').textContent = 'Error: ' + err;
                console.error(err);
            }
        }
    </script>
</body>
</html>